<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soil Humidity Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f4f4f9;
            margin: 0;
            padding: 20px;
        }
        h1 {
            color: #333;
        }
        #humidityChart {
            max-width: 800px;
            width: 100%;
        }
        #errorMessage {
            color: red;
            margin-top: 20px;
        }
        #dataPreview {
            margin-top: 20px;
            max-width: 800px;
            background-color: #fff;
            padding: 10px;
            border: 1px solid #ccc;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>Soil Humidity Over Time</h1>
    <canvas id="humidityChart"></canvas>
    <div id="errorMessage"></div>
    <div id="dataPreview"></div>

    <script>
        async function fetchHumidityData() {
            try {
                // Replace with your API endpoint
                const response = await fetch('https://espbackend-production.up.railway.app/api/log');
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const data = await response.json();
                console.log('Raw API data:', data);
                return data;
            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('errorMessage').textContent = 'Failed to fetch data: ' + error.message;
                return [];
            }
        }

        function displayDataPreview(data) {
            const previewDiv = document.getElementById('dataPreview');
            if (data.length === 0) {
                previewDiv.textContent = 'No data to display.';
                return;
            }
            const ul = document.createElement('ul');
            data.forEach(entry => {
                const li = document.createElement('li');
                li.textContent = `Timestamp: ${entry.timestamp}, Humidity: ${entry.humidity}%`;
                ul.appendChild(li);
            });
            previewDiv.appendChild(ul);
        }

        function createChart(data) {
            // Process and validate data
            const processedData = data.map(entry => ({
                timestamp: new Date(entry.timestamp),
                humidity: parseFloat(entry.humidity)
            })).filter(entry => !isNaN(entry.humidity) && entry.timestamp instanceof Date && !isNaN(entry.timestamp.getTime()));

            console.log('Processed chart data:', processedData);

            if (processedData.length === 0) {
                document.getElementById('errorMessage').textContent = 'No valid data to display in chart.';
                return;
            }

            const ctx = document.getElementById('humidityChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: processedData.map(entry => entry.timestamp.toLocaleString()),
                    datasets: [{
                        label: 'Soil Humidity (%)',
                        data: processedData.map(entry => entry.humidity),
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointBackgroundColor: 'rgba(75, 192, 192, 1)',
                        pointBorderColor: '#fff',
                        pointHoverRadius: 8,
                        borderWidth: 2,
                        showLine: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Humidity (%)'
                            },
                            ticks: {
                                stepSize: 10
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Timestamp'
                            },
                            ticks: {
                                maxTicksLimit: 10
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                        }
                    }
                }
            });
        }

        async function init() {
            const humidityData = await fetchHumidityData();
            displayDataPreview(humidityData);
            if (humidityData.length > 0) {
                createChart(humidityData);
            } else {
                document.getElementById('humidityChart').replaceWith(
                    document.createTextNode('No data available to display.')
                );
                document.getElementById('errorMessage').textContent = 'No data available.';
            }
        }

        window.onload = init;
    </script>
</body>
</html>

